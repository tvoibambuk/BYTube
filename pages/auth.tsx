import { useEffect, useState } from 'react'\nimport { supabase } from '../lib/supabaseClient'\nimport { useRouter } from 'next/router'\n\nexport default function AuthPage() {\n  const router = useRouter()\n  const [email, setEmail] = useState('')\n  const [loading, setLoading] = useState(false)\n  const [message, setMessage] = useState<string | null>(null)\n  const [user, setUser] = useState<any>(null)\n\n  useEffect(() => {\n    // Проверяем сессию при загрузке\n    supabase.auth.getSession().then(res => {\n      const session = (res as any).data?.session\n      if (session) {\n        setUser(session.user)\n        // при наличии сессии можно сразу редиректить на главную\n        // router.replace('/')\n      }\n    })\n\n    const { data: listener } = supabase.auth.onAuthStateChange((event, session) => {\n      setUser(session?.user ?? null)\n      if (session?.user) {\n        setMessage('Вход выполнен')\n        // редирект после входа\n        router.replace('/')\n      }\n    })\n\n    return () => {\n      // @ts-ignore\n      listener?.subscription?.unsubscribe && listener.subscription.unsubscribe()\n    }\n  }, [router])\n\n  async function signInWithGoogle() {\n    setLoading(true)\n    setMessage(null)\n    try {\n      const { error } = await supabase.auth.signInWithOAuth({\n        provider: 'google',\n        options: {\n          // redirectTo можно не указывать, Supabase использует текущий origin.\n          // redirectTo: 'http://localhost:3000'\n        }\n      })\n      if (error) throw error\n      setMessage('Откроется окно для входа через Google...')\n    } catch (err: any) {\n      console.error(err)\n      setMessage('Ошибка: ' + (err.message || err.error_description || String(err)))\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  async function sendMagicLink(e: any) {\n    e.preventDefault()\n    if (!email) {\n      setMessage('Введите email')\n      return\n    }\n    setLoading(true)\n    setMessage(null)\n    try {\n      const { data, error } = await supabase.auth.signInWithOtp({ email })\n      if (error) throw error\n      // data will contain: user: null (for magic link), message supplied by supabase\n      setMessage('Письмо с ссылкой отправлено (проверьте почту).')\n    } catch (err: any) {\n      console.error(err)\n      setMessage('Ошибка: ' + (err.message || String(err)))\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  async function signOut() {\n    await supabase.auth.signOut()\n    setUser(null)\n    setMessage('Вы вышли')\n  }\n\n  return (\n    <div>\n      <h2 className="text-lg font-semibold mb-3">Вход / Регистрация</h2>\n\n      {user ? (\n        <div className="card p-3">\n          <div className="mb-2">Вы вошли как <strong>{user.email}</strong></div>\n          <button onClick={signOut} className="px-3 py-2 rounded bg-red-600 text-white">Выйти</button>\n        </div>\n      ) : (\n        <>\n          <div className="flex flex-col gap-3 mb-4">\n            <button\n              onClick={signInWithGoogle}\n              className="w-full px-3 py-2 rounded bg-white/5 flex items-center justify-center gap-2"\n              disabled={loading}\n            >\n              <span>Войти через Google</span>\n            </button>\n\n            <form onSubmit={sendMagicLink} className="flex gap-2">\n              <input\n                type="email"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                placeholder="Email для magic link"\n                className="flex-1 p-2 rounded bg-white/5"\n              />\n              <button type="submit" disabled={loading} className="px-3 py-2 rounded bg-accent text-white">\n                {loading ? 'Отправляем...' : 'Отправить'}\n              </button>\n            </form>\n\n            <div className="text-sm text-[#94a3b8]">\n              Можно войти через Google или получить magic link на email (без пароля).\n            </div>\n          </div>\n        </>\n      )}\n\n      {message && <div className="text-sm text-[#94a3b8] mt-2">{message}</div>}\n    </div>\n  )\n}